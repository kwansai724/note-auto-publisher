name: note下書き自動公開

on:
  schedule:
    - cron: '0 11 * * *'  # JST 20:00 = UTC 11:00
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'DRY RUNモード（公開せずに確認のみ）'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: チェックアウト
        uses: actions/checkout@v4

      - name: Node.js セットアップ
        uses: actions/setup-node@v4
        with:
          node-version: '>=24.13'
          cache: 'npm'

      - name: 依存パッケージインストール
        run: npm ci

      - name: Playwright ブラウザインストール
        run: npx playwright install chromium --with-deps

      - name: 認証情報マスク
        run: |
          echo "::add-mask::${{ secrets.NOTE_EMAIL }}"
          echo "::add-mask::${{ secrets.NOTE_PASSWORD }}"
          echo "::add-mask::${{ secrets.GAS_WEBHOOK_URL }}"

      - name: 下書き公開実行
        env:
          NOTE_EMAIL: ${{ secrets.NOTE_EMAIL }}
          NOTE_PASSWORD: ${{ secrets.NOTE_PASSWORD }}
          GAS_WEBHOOK_URL: ${{ secrets.GAS_WEBHOOK_URL }}
          NOTIFICATION_EMAIL: ${{ secrets.NOTIFICATION_EMAIL }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          HEADLESS: 'true'
        run: npm start

      - name: queue.yml / history.yml の変更をコミット
        run: |
          git diff --quiet queue.yml && git diff --quiet --no-index /dev/null history.yml 2>/dev/null && exit 0
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add queue.yml history.yml
          git diff --cached --quiet && exit 0
          git commit -m "公開済み記事をキューから削除・履歴を更新"
          git push

      - name: エラー時スクリーンショット保存
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-screenshots
          path: screenshots/
          retention-days: 7
          if-no-files-found: ignore
